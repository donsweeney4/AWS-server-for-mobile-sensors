<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Added viewport for responsiveness -->
    <title>Select Campaign</title>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Recommended font */
            margin: 20px;
            background-color: #f0f4f8; /* Light background for modern look */
            color: #333;
        }

        h1 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 2em;
            text-align: center;
        }

        h3 {
            margin-bottom: 10px;
            color: #34495e;
            text-align: center;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); /* Subtle shadow for tables */
            border-radius: 8px; /* Rounded corners for the table */
            overflow: hidden; /* Ensures rounded corners are applied to content */
        }

        td, th {
            padding: 10px 15px; /* Increased padding for better readability */
            vertical-align: middle; /* Center vertically */
            border-bottom: 1px solid #ddd; /* Light separator */
        }

        th {
            background-color: #ecf0f1;
            font-weight: bold;
            color: #2c3e50;
            text-align: left;
        }

        .label-bold-red {
            color: #e74c3c; /* A slightly softer red */
            font-weight: bold;
        }

        .radio-cell {
            text-align: center;
        }

        /* === Percentage-based Column Widths === */
        /* Adjusted widths to ensure all fit and look good */
        .col1 { width: 3%; } /* Radio button column */
        .col2 { width: 8%; } /* Run date label */
        .col3 { width: 10%; } /* Run date value */
        .col4 { width: 9%; } /* Campaign ID label */
        .col5 { width: 12%; } /* Campaign ID value */
        .col6 { width: 6%; } /* Title label */
        .col7 { width: 25%; } /* Title value */
        .col8 { width: 7%; } /* Owners label */
        .col9 { width: 12%; } /* Owners value */
        .col10 { width: 3%; } /* Hidden checkbox label */
        .col11 { width: 5%; } /* Hidden checkbox */

        /* === Row Styling === */
        .odd-row {
            background-color: #ecfcf1; /* Lighter shade of green */
        }
        .even-row {
            background-color: #e0f8e9; /* Slightly darker shade of green */
        }

        .odd-row:hover, .even-row:hover {
            background-color: #d1f7df; /* Hover effect */
        }

        input[type="radio"], input[type="checkbox"] {
            transform: scale(1.2); /* Slightly larger checkboxes/radios */
            margin: 0 5px;
        }

        label {
            margin-left: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<h1>Select a Campaign</h1>
<h3>Ordered by run date </h3>
<h3>
    <!-- These radio buttons will trigger an AJAX load, not a form submission -->
    <input type="radio" id="show_all" name="visibility" value="show_all" checked> 
    <label for="show_all">Show Active Campaigns</label>
    <input type="radio" id="show_hidden" name="visibility" value="show_hidden">
    <label for="show_hidden">Show All Campaigns (including Hidden)</label>
</h3>

<form action="/submit_registration" method="POST" id="campaignForm">
    <div id="campaignRadios">
        <!-- Tables with campaign info and radio buttons will go here -->
        <p>Loading campaigns...</p> <!-- Initial loading message -->
    </div>
</form>

<script>
    // Get references to the radio buttons for showing hidden/all campaigns
    const showAllRadio = document.getElementById('show_all');
    const showHiddenRadio = document.getElementById('show_hidden');

    // Add event listeners to trigger loadCampaigns on change
    showAllRadio.addEventListener('change', loadCampaigns);
    showHiddenRadio.addEventListener('change', loadCampaigns);

    /**
     * Fetches campaign data from the backend and renders it into tables.
     * It sends the visibility preference (show hidden or not) to the backend.
     */
    async function loadCampaigns() {
        const container = document.getElementById('campaignRadios');
        const form = document.getElementById('campaignForm');

        // Determine the visibility setting based on which radio button is checked
        const showHidden = showHiddenRadio.checked; 

        // Display a loading message while fetching data
        container.innerHTML = '<p>Loading campaigns...</p>';

        try {
            // Make a POST request to the backend with the visibility preference
            const response = await fetch('/get_campaign_locations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                // Send the 'show_hidden' status in the request body as JSON
                body: JSON.stringify({ show_hidden: showHidden }) 
            });

            // Check if the response was successful (e.g., HTTP status 200-299)
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`HTTP error! status: ${response.status}, details: ${errorData.error || 'Unknown error'}`);
            }

            const result = await response.json();
            const campaigns = result.campaigns;
            const selected = result.selected; // The ID of the currently selected campaign from the backend

            // Clear previous content before adding new tables
            container.innerHTML = ''; 

            // If no campaigns are available, display a message and exit
            if (!Array.isArray(campaigns) || campaigns.length === 0) {
                container.innerHTML = '<p>No campaigns available.</p>';
                return;
            }

            // Iterate over each campaign and create a new table row for it
            campaigns.forEach((campaign, index) => {
                const id = campaign.campaign_id ?? 'Unknown'; // Use 'Unknown' if campaign_id is null/undefined

                const table = document.createElement('table'); // Create a table for each campaign row
                                                              // This creates individual tables which might not be desired.
                                                              // Often, all campaign rows go into one <table>.
                                                              // If you want a single table, create <table> once outside the loop
                                                              // and append <tr> elements to its <tbody>.
                                                              // For now, retaining user's original structure of one table per row.

                const tr = document.createElement('tr');
                // Apply alternating row styles
                tr.className = (index % 2 === 0) ? 'even-row' : 'odd-row'; // Switched for more common alternating pattern


                // Column 1: Radio button for campaign selection
                const tdRadio = document.createElement('td');
                tdRadio.className = 'radio-cell col1';
                const radio = document.createElement('input');
                radio.type = 'radio';
                radio.name = 'campaign_id'; // Name for the radio button group
                radio.value = id;
                // Check if this campaign's ID matches the selected ID from the backend
                if (id === selected) {
                    radio.checked = true;
                }
                // Add an event listener to submit the form when a radio button is changed
                radio.addEventListener('change', () => requestAnimationFrame(() => form.submit()));
                tdRadio.appendChild(radio);
                tr.appendChild(tdRadio);

                // Column 2–3: Run Date
                const tdRunDateLabel = document.createElement('td');
                tdRunDateLabel.className = 'label-bold-red col2';
                tdRunDateLabel.textContent = 'Run date:';
                const tdRunDate = document.createElement('td');
                tdRunDate.className = 'col3';
                tdRunDate.textContent = campaign.run_date ?? ''; // Display run_date
                tr.appendChild(tdRunDateLabel);
                tr.appendChild(tdRunDate);

                // Column 4–5: Campaign ID
                const tdCampaignIdLabel = document.createElement('td');
                tdCampaignIdLabel.className = 'label-bold-red col4';
                tdCampaignIdLabel.textContent = 'Campaign id:';
                const tdCampaignId = document.createElement('td');
                tdCampaignId.className = 'col5';
                tdCampaignId.textContent = campaign.campaign_id ?? ''; // Display campaign_id
                tr.appendChild(tdCampaignIdLabel);
                tr.appendChild(tdCampaignId);

                // Column 6–7: Title
                const tdTitleLabel = document.createElement('td');
                tdTitleLabel.className = 'label-bold-red col6';
                tdTitleLabel.textContent = 'Title:';
                const tdTitle = document.createElement('td');
                tdTitle.className = 'col7';
                tdTitle.textContent = campaign.campaign_title ?? ''; // Display campaign_title
                tr.appendChild(tdTitleLabel);
                tr.appendChild(tdTitle);

                // Column 8–9: Owners
                const tdOwnersLabel = document.createElement('td');
                tdOwnersLabel.className = 'label-bold-red col8';
                tdOwnersLabel.textContent = 'Owners:';
                const tdOwners = document.createElement('td');
                tdOwners.className = 'col9';
                tdOwners.textContent = campaign.owners ?? ''; // Display owners
                tr.appendChild(tdOwnersLabel);
                tr.appendChild(tdOwners);

                // Column 10-11: Optional 'Hide' checkbox
                const tdHiddenLabel = document.createElement('td');
                tdHiddenLabel.className = 'label-bold-red col10'; 
                tdHiddenLabel.textContent = 'Hide:';
                tr.appendChild(tdHiddenLabel);

                const tdHiddenCheckboxCell = document.createElement('td'); 
                tdHiddenCheckboxCell.className = 'radio-cell col11'; 

                const hiddenCheckbox = document.createElement('input'); 
                hiddenCheckbox.type = 'checkbox'; // It's a checkbox now
                // Name it uniquely per campaign ID for proper form submission if needed later
                hiddenCheckbox.name = 'campaign_hidden_' + id; 
                hiddenCheckbox.value = id; // Value can be the campaign ID
                // Set checked state based on 'campaign.hidden' from the backend
                if (campaign.hidden) { 
                    hiddenCheckbox.checked = true;
                }
                // If you want this checkbox to update the campaign's hidden status in the DB
                // you would add an event listener here to make an AJAX call to /update_campaign
                // Example (uncomment if you want this functionality):
                
                hiddenCheckbox.addEventListener('change', async (event) => {
                    const isHidden = event.target.checked;
                    try {
                        const updateResponse = await fetch('/update_hidden', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ 
                                campaign_id: id, 
                                hidden: isHidden 
                            })
                        });
                        if (!updateResponse.ok) {
                            const errorData = await updateResponse.json();
                            console.error('Failed to update hidden status:', errorData.error || 'Unknown error');
                            alert('Failed to update campaign hidden status.'); // Use custom modal in real app
                            // Revert checkbox state if update fails
                            event.target.checked = !isHidden; 
                        } else {
                            console.log(`Campaign ${id} hidden status updated to ${isHidden}`);
                        }
                    } catch (updateErr) {
                        console.error('Error updating hidden status:', updateErr);
                        alert('An error occurred while updating hidden status.'); // Use custom modal in real app
                        event.target.checked = !isHidden; // Revert checkbox state on network error
                    }
                });
                
                
                tdHiddenCheckboxCell.appendChild(hiddenCheckbox);
                tr.appendChild(tdHiddenCheckboxCell);

                // Append the row to the table, and the table to the container
                table.appendChild(tr);
                container.appendChild(table);
            });

        } catch (err) {
            console.error('Error loading campaigns:', err);
            container.innerHTML = `<p style="color: red;">Error loading campaigns: ${err.message}. Please try again.</p>`;
        }
    }

    // Call loadCampaigns on page load to initially populate the campaigns
    window.onload = loadCampaigns; 
</script>

</body>
</html>
